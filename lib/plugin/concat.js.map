{"version":3,"sources":["../../src/plugin/concat.js"],"names":[],"mappings":";;;;;;;;sBAAc,QAAQ;;;;iCACY,sBAAsB;;oCACR,yBAAyB;;wBAC9C,WAAW;;qBAEvB,UAAS,EAAE,EAAE,UAAU,EAAE;AACtC,MAAI,UAAU,GAAG,KAAK,CAAA;AACtB,MAAI,aAAa,GAAG,IAAI,IAAI,CAAC,CAAC,gBAAgB,CAAC,CAAA;;AAE/C,SAAO,0CAAkB,EAAE,CAAC,MAAM,CAAC,CAClC,GAAG,CAAC,UAAS,UAAU,EAAE;AACxB,QAAI,IAAI,GAAG,EAAE;QAAE,UAAU,GAAG,EAAE,CAAA;AAC9B,QAAI,OAAO,GAAG,CAAC,CAAC,CAAC;QAAE,SAAS,GAAG,CAAC,CAAA;AAChC,QAAI,MAAM,GAAG,oBAAE,MAAM,CAAC,UAAU,EAAE,aAAa,CAAC,CAAA;;;AAGhD,QAAI,UAAU,GAAG,IAAI,CAAA;AACrB,QAAI,iBAAiB,GAAG,aAAa,CAAA;;AAErC,UAAM,CAAC,OAAO,CAAC,UAAC,KAAK,EAAE,GAAG,EAAK;AAC7B,UAAI,KAAK,CAAC,UAAU,GAAG,aAAa,EAAE;AACpC,YAAI,KAAK,CAAC,UAAU,GAAG,UAAU,IAAI,UAAU,KAAK,IAAI,EACtD,UAAU,GAAG,KAAK,CAAC,UAAU,CAAA;;AAE/B,YAAI,KAAK,CAAC,UAAU,GAAG,iBAAiB,EACtC,iBAAiB,GAAG,KAAK,CAAC,UAAU,CAAA;OACvC;;AAED,UAAI,MAAM,GAAG,KAAK,CAAC,SAAS,GAAG,CAAC,CAAA;AAChC,UAAI,IAAI,KAAK,CAAC,IAAI,CAAA;AAClB,UAAI,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,KAAK,IAAI,EAAE;AAClC,YAAI,IAAI,IAAI,CAAA;AACZ,UAAE,MAAM,CAAA;OACT;;AAED,UAAI,SAAS,CAAA;AACb,UAAI;AACF,iBAAS,GAAG,KAAK,CAAC,SAAS,CAAA;OAC5B,CACD,OAAO,CAAC,EAAE;AACR,sBAAI,IAAI,CAAC,oDAAoD,EAAE,KAAK,CAAC,WAAW,CAAC,CAAA;AACjF,YAAI,CAAC,CAAC,OAAO,EACX,cAAI,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,CAAA;OACtB;;AAED,UAAI,SAAS,EAAE;AACb,kBAAU,CAAC,IAAI,CAAC,SAAS,CAAC,CAAA;OAC3B;;AAED,UAAI,GAAG,GAAG,MAAM,CAAC,MAAM,GAAG,CAAC,EACzB,OAAO,CAAC,IAAI,CAAC,SAAS,IAAI,MAAM,CAAC,CAAA;KACpC,CAAC,CAAA;;;AAGF,QAAI,UAAU,KAAK,IAAI,EACrB,UAAU,GAAG,aAAa,CAAA;;AAE5B,iBAAa,GAAG,iBAAiB,CAAA;;AAEjC,QAAI,SAAS,GAAG,uCAAiB,UAAU,EAAE,OAAO,CAAC,CAAA;AACrD,aAAS,CAAC,IAAI,GAAG,UAAU,CAAA;;AAE3B,QAAI,GAAG,GAAG,CAAE,oBAAU;AACpB,UAAI,EAAE,UAAU,GAAG,QAAQ,GAAG,KAAK;AACnC,UAAI,EAAE,UAAU;AAChB,UAAI,EAAJ,IAAI;AACJ,eAAS,EAAT,SAAS;AACT,gBAAU,EAAV,UAAU;AACV,eAAS,EAAE,CAAE,MAAM,CAAC,IAAI,CAAC,UAAA,KAAK;eAAI,CAAE,KAAK,CAAC,SAAS;OAAA,CAAC;KACrD,CAAC,CAAE,CAAA;AACJ,cAAU,GAAG,IAAI,CAAA;AACjB,WAAO,GAAG,CAAA;GACX,CAAC,CAAA;CACH","file":"concat.js","sourcesContent":["import _ from 'lodash'\nimport { toFileSystemState } from 'sigh-core/lib/stream'\nimport { concatenate as concatSourceMaps } from 'sigh-core/lib/sourceMap'\nimport { log, Event } from 'sigh-core'\n\nexport default function(op, outputPath) {\n  var fileExists = false\n  var maxCreateTime = new Date(-8640000000000000)\n\n  return toFileSystemState(op.stream)\n  .map(function(eventCache) {\n    var data = '', sourceMaps = []\n    var offsets = [0], cumOffset = 0\n    var events = _.sortBy(eventCache, 'opTreeIndex')\n\n    // set this to the earliest new createTime after maxCreateTime\n    var createTime = null\n    var nextMaxCreateTime = maxCreateTime\n\n    events.forEach((event, idx) => {\n      if (event.createTime > maxCreateTime) {\n        if (event.createTime < createTime || createTime === null)\n          createTime = event.createTime\n\n        if (event.createTime > nextMaxCreateTime)\n          nextMaxCreateTime = event.createTime\n      }\n\n      var offset = event.lineCount - 1\n      data += event.data\n      if (data[data.length - 1] !== '\\n') {\n        data += '\\n'\n        ++offset\n      }\n\n      var sourceMap\n      try {\n        sourceMap = event.sourceMap\n      }\n      catch (e) {\n        log.warn('\\x07could not construct identity source map for %s', event.projectPath)\n        if (e.message)\n          log.warn(e.message)\n      }\n\n      if (sourceMap) {\n        sourceMaps.push(sourceMap)\n      }\n\n      if (idx < events.length - 1)\n        offsets.push(cumOffset += offset)\n    })\n\n    // is null when none of the creation times was greater than the previous\n    if (createTime === null)\n      createTime = maxCreateTime\n\n    maxCreateTime = nextMaxCreateTime\n\n    var sourceMap = concatSourceMaps(sourceMaps, offsets)\n    sourceMap.file = outputPath\n\n    var ret = [ new Event({\n      type: fileExists ? 'change' : 'add',\n      path: outputPath,\n      data,\n      sourceMap,\n      createTime,\n      initPhase: ! events.some(event => ! event.initPhase)\n    }) ]\n    fileExists = true\n    return ret\n  })\n}\n"]}